
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Using NWB Data</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2018-12-27"><meta name="DC.source" content="plotSession.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Using NWB Data</h1><!--introduction--><p>How to interface with Neurodata Without Borders files using MatNWB. We create a raster map of spikes extracted for the dataset extracted from the <a href="https://neurodatawithoutborders.github.io/matnwb/tutorials/html/alm3ToNwb.html">File Conversion Tutorial</a>.</p><pre>author: Lawrence Niu
contact: lawrence@vidriotech.com
last updated: Dec 26, 2018</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Reading NWB Files</a></li><li><a href="#2">Constrained Sets</a></li><li><a href="#4">Accessing Data</a></li></ul></div><h2 id="1">Reading NWB Files</h2><p>NWB files can be read using the nwbRead() function. This function returns an 'nwbfile' object which represents the nwb file structure.</p><pre class="codeinput">nwb = nwbRead(<span class="string">'out\ANM255200_20140911.nwb'</span>);
</pre><h2 id="2">Constrained Sets</h2><p>Analyzed data in NWB is placed under the <i>analysis</i> property, which is a <b>Constrained Set</b>. A constrained set consists of an arbitrary amount of key-value pairs representing properties.  Constrained sets are so called because they are capable of basic type-checking, allowing for more constraints than simply using a Map.</p><p>You can get/set values in constrained sets using the methods .get() and .set() respectively, and retrieve all Set properties using the keys() method;</p><pre class="codeinput">units = keys(nwb.analysis);
</pre><h2 id="4">Accessing Data</h2><p>The following line of code shows how to access nwb data.</p><pre class="codeinput">startTimes = nwb.intervals.get(<span class="string">'trials'</span>).start_time.data.load();
</pre><p>The line on its own can be quite intimidating but should be fairly intuitive when broken down.</p><pre class="language-matlab">nwb.intervals
</pre><p>This returns a Constrained Set containing interval data, with which we retrieve the "trials" table using the get() method.  "trials" is a time interval (types.core.TimeInterval) which is a dynamic table (inherits from types.core.DynamicTable).  Dynamic tables allow for an arbitrary number of columns.</p><pre class="language-matlab">start_time.data.load()
</pre><p>This call returns the column data in "start time".  All datasets, by default, are not loaded by default and require an explicit call to load() to retrieve.  You can identify unloaded data if the type is a `types.untyped.DataStub` instead of the actual data.</p><p>We now read from all units and plot out all detected spikes relative to their respective start times.</p><pre class="codeinput">xs = [];
ys = [];
<span class="keyword">for</span> i=1:length(units)
    u = nwb.analysis.get(units{i});

    [tIdentifier, ~, tIndex] = unique(u.control.load());
    unit_ts = u.timestamps.load();
    <span class="keyword">for</span> k=1:length(tIdentifier)
        id = tIdentifier(k);
        tLogical = tIndex == k;
        len = sum(tLogical);
        xs(end+1:end+len) = unit_ts(tLogical) - startTimes(id);
        ys(end+1:end+len) = id;
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p>The raster plot of spikes look like this.</p><pre class="codeinput">hScatter = scatter(xs, ys, <span class="string">'Marker'</span>, <span class="string">'.'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'flat'</span>,<span class="keyword">...</span>
    <span class="string">'CData'</span>, [0 0 0], <span class="string">'SizeData'</span>, 1);

hAxes = hScatter.Parent;
hAxes.YLabel.String = <span class="string">'Trial number'</span>;
hAxes.XLabel.String = <span class="string">'Time (sec)'</span>;
hAxes.XTick = 0:max(xs);
hAxes.YTick = 0:50:max(ys);
hAxes.Parent.Position(4) = hAxes.Parent.Position(4) * 2;
snapnow;
</pre><img vspace="5" hspace="5" src="plotSession_01.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Using NWB Data
% How to interface with Neurodata Without Borders files using MatNWB.
% We create a raster map of spikes extracted for the dataset extracted from the
% <https://neurodatawithoutborders.github.io/matnwb/tutorials/html/alm3ToNwb.html File Conversion Tutorial>.
%
%  author: Lawrence Niu
%  contact: lawrence@vidriotech.com
%  last updated: Dec 26, 2018
%
%% Reading NWB Files
% NWB files can be read using the nwbRead() function.
% This function returns an 'nwbfile' object which represents the nwb file structure.
%
nwb = nwbRead('out\ANM255200_20140911.nwb');
%% Constrained Sets
% Analyzed data in NWB is placed under the _analysis_ property, which is a *Constrained Set*.
% A constrained set consists of an arbitrary amount of key-value pairs representing
% properties.  Constrained sets are so called because they are capable of basic type-checking,
% allowing for more constraints than simply using a Map.
%%
% You can get/set values in constrained sets using the methods .get() and .set()
% respectively, and retrieve all Set properties using the keys() method;
units = keys(nwb.analysis);
%% Accessing Data
% The following line of code shows how to access nwb data.
startTimes = nwb.intervals.get('trials').start_time.data.load();
%%
% The line on its own can be quite intimidating but should be fairly intuitive when broken down.
%%
%   nwb.intervals
%%
% This returns a Constrained Set containing interval data, with which we retrieve the
% "trials" table using the get() method.  "trials" is a time interval (types.core.TimeInterval) which is a dynamic table
% (inherits from types.core.DynamicTable).  Dynamic tables allow for an arbitrary number of columns.
%%
%   start_time.data.load()
%%
% This call returns the column data in "start time".  All datasets, by default, are
% not loaded by default and require an explicit call to load() to retrieve.  You can
% identify unloaded data if the type is a `types.untyped.DataStub` instead of the
% actual data.
%
% We now read from all units and plot out all detected spikes relative to their respective start times.
xs = [];
ys = [];
for i=1:length(units)
    u = nwb.analysis.get(units{i});
    
    [tIdentifier, ~, tIndex] = unique(u.control.load());
    unit_ts = u.timestamps.load();
    for k=1:length(tIdentifier)
        id = tIdentifier(k);
        tLogical = tIndex == k;
        len = sum(tLogical);
        xs(end+1:end+len) = unit_ts(tLogical) - startTimes(id);
        ys(end+1:end+len) = id;
    end
end
%%
% The raster plot of spikes look like this.
hScatter = scatter(xs, ys, 'Marker', '.', 'MarkerFaceColor', 'flat',...
    'CData', [0 0 0], 'SizeData', 1);

hAxes = hScatter.Parent;
hAxes.YLabel.String = 'Trial number';
hAxes.XLabel.String = 'Time (sec)';
hAxes.XTick = 0:max(xs);
hAxes.YTick = 0:50:max(ys);
hAxes.Parent.Position(4) = hAxes.Parent.Position(4) * 2;
snapnow;


##### SOURCE END #####
--></body></html>